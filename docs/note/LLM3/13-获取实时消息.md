# 13~15-获取实时消息 part1

## 13-记忆

1. 类似医生治病：先让你去哪里检查，完成流程后告诉你结果
2. 新增工具箱；提示词；server/utils/; dotenv 配置后端环境变量；.env; 和风天气 api；百度翻译 api；注册得到 appkey；
3. translateHandler.js; crypto; whetherHandler.js; formatDate; getCityLocation; 使用私有 host；getWeather;
4. 和风 key: e8484fc8d1654bcc8bf01dac6344f91b; host: abc1234xyz.def.qweatherapi.com
   ;
5. 百度翻译 key: 20250831002443392; scret: FIdsNosmK7eeH00G96lU;
6. .env

```
LLM_ENDPOINT=http://localhost:11434/api/generate
LLM_MODEL=deepseek-r1:1.5b
LLM_TIMEOUT_MS=30000
HEFENG_API_KEY=e8484fc8d1654bcc8bf01dac6344f91b
BAIDU_APP_ID=20250831002443392
BAIDU_SECRET_KEY=FIdsNosmK7eeH00G96lU
```

## 14-记忆

1. 是否流式；utils/LLM.js; callLLM, callLLMStream; fetchWithTimeout; AbortController;
2. LLM.js

```js
const LLM_ENDPOINT = process.env.LLM_ENDPOINT;
const LLM_MODEL = process.env.LLM_MODEL;
const LLM_TIMEOUT_MS = process.env.LLM_TIMEOUT_MS;

async function fetchWithTimeout(url, options) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), LLM_TIMEOUT_MS);
  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
    });
    clearTimeout(timeout);
    return response;
  } catch (error) {
    clearTimeout(timeout);
    if (error.name === "AbortError") {
      throw new Error("模型请求超时");
    }
    throw error;
  }
}

async function callLLM({ prompt, stream = false, callback = null }) {
  const response = await fetchWithTimeout(LLM_ENDPOINT, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model: LLM_MODEL,
      prompt: prompt,
      stream,
    }),
  });
  if (!response?.ok)
    throw new Error(
      `模型请求失败☹️：${response.status} : ${response.statusText}`
    );
  if (!stream) {
    const data = await response.json();
    return data.response;
  }

  let fullResponse = "";

  const reader = response.body.getReader();
  const decoder = new TextDecoder("utf-8");
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value, { stream: true });
    const lines = chunk.split("\n").filter((line) => line.trim());
    for (const line of lines) {
      try {
        const data = JSON.parse(line);
        if (data.response) {
          fullResponse += data.response;
          callback?.(data.response);
        }
      } catch (error) {
        console.error("解析JSON错误:", error.message);
      }
    }
  }
  return fullResponse;
}

module.exports = {
  callLLMStream: (prompt, callback) =>
    callLLM({ prompt, stream: true, callback }),
  callLLM: (prompt) => callLLM({ prompt, stream: false }),
};
```

## 15-记忆

1. getWheather, translate; toolsMap; 大模型判断是否需要翻译；promptTemplates.js, buildFunctionCallPrompt, 严格要求大模型; functionCallResult; 加载环境变量, dotenv; 调试；无函数调用，调试；toolCalls; toolsResult; function, args, result; 工具调用失败；工具不存在；解析工具失败；调试打印 toolsResult; buildAnswerPrompt; callLLMStream;
2. promptTemplates.js

```js
// 提示词模板

function buildFunctionCallPrompt(userInput) {
  return `
    你是一个中文智能助手，具有工具调用能力。请严格按照以下规则回复：
    
    请根据用户的输入内容判断是否需要调用函数工具，规则如下：
    
    1. 如果不需要调用函数工具，请直接返回字符串："无函数调用"（必须完全一致）
    2. 如果需要调用函数，请返回标准JSON数组格式。
    
    JSON格式示例（正确）：
    [
      {
        "function": "translate",
        "args": { "input": "我今天很开心" }
      }
    ]
    
    [
      {
        "function": "getWeather", 
        "args": { "city": "北京", "date": "明天" }
      }
    ]
    
    ❌ 错误格式（绝对不要这样写）：
    - { "input": ""我今天很开心"" }  # 双引号嵌套
    - { "input": "我今天很开心"" }   # 结尾双引号
    - { "input": ""我今天很开心" }   # 开头双引号
    
    ✅ 正确格式（必须这样写）：
    - { "input": "我今天很开心" }     # 标准JSON格式
    
    关键要求：
    - 参数值只需要一层双引号，不要嵌套引号
    - 中文文本直接放在双引号内，不需要额外处理
    - 必须是有效的JSON，能够被JSON.parse()正确解析
    
    目前你支持的函数列表如下：
    - getWeather：获取城市的天气信息
      参数要求：
      * city: 城市名称（必须是中文，如"北京"、"上海"、"成都"）
      * date: 日期（必须是中文，只能是："今天"、"明天"、"后天"）
    - translate：用于中英文互译
      参数要求：
      * input: 需要翻译的文本
    
    严格要求：
    - 如果不需要调用函数，只返回"无函数调用"这5个字
    - 如果需要调用函数，只返回JSON数组，不要包含其他文字解释
    - 所有参数值必须使用中文，禁止使用英文
    - date参数只能是"今天"、"明天"、"后天"，不能是其他格式
    - JSON必须严格正确，不能有双引号嵌套问题
    
    ⚠️ 特别注意：返回的JSON必须能被JSON.parse()正确解析，任何格式错误都会导致系统无法处理！
    
    以下是用户的输入，请根据内容判断是否需要函数调用：
    
    【${userInput}】
    
    记住：如果需要调用函数，请确保返回的JSON格式完全正确，参数值不要有额外的引号！
    `.trim();
}

/**
 * 🤖 工具已执行后的回答 Prompt
 * @param {string} userInput - 用户原始的问题
 * @param {Array} results - 工具调用的结构化结果
 */
function buildAnswerPrompt(userInput, results) {
  const toolsText = results
    .map((item) => {
      const { function: fn, args, result } = item;
      return `函数：${fn}\n参数：${JSON.stringify(args)}\n返回结果：${result}`;
    })
    .join("\n\n");

  /**
       * 函数：addNumbers
         参数：{"a":3,"b":5}
         返回结果：8
  
         函数：getWeather
         参数：{"city":"上海"}
         返回结果：天气晴朗，城市：上海
       */

  return `
      你是一个友好的中文智能助手，已经执行了相关函数调用，以下是函数返回结果：
      
      ${toolsText}
      
      请基于上述工具结果，严格使用中文自然语言回答用户的问题。
      
      要求：
      - 使用友好、自然的语调
      - 如果工具调用成功，直接提供结果信息
      - 如果工具调用失败，友好地告知用户并建议重新尝试
      - 不要暴露技术细节或系统错误信息
      - 回答要简洁明了
      
      用户原始输入是：
      【${userInput}】
      `.trim();
}

module.exports = {
  buildFunctionCallPrompt,
  buildAnswerPrompt,
};
```

3. [压缩包](/public/zip/13_15-获取实时消息.zip)
